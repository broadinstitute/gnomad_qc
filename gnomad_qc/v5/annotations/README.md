# gnomAD v5 Frequency Calculation

This directory contains scripts for calculating variant frequencies and generating age histograms for gnomAD v5.

## Overview

The v5 frequency calculation uses a differential analysis approach to avoid densifying the full dataset. Instead of processing all samples, the script focuses on:

1. **Samples that will be removed from v5** due to relatedness filtering
2. **Samples that change ancestry** between v4 and v5
3. **All of Us samples that will be filtered out** based on QC criteria

## Key Features

### Differential Analysis Approach

The script identifies samples that will be removed or have changed characteristics and calculates frequency data only for these subsets. This approach:

- Reduces computational requirements
- Avoids densifying the full dataset
- Focuses on the differences between v4 and v5
- Enables efficient frequency updates

### Coverage Integration

The script integrates with the coverage computation output to use AN (allele number) data generated by the coverage script. This ensures accurate frequency calculations that account for:

- Sample filtering effects on allele numbers
- Coverage-based quality metrics
- Reference genome coverage statistics

### Ancestry Change Detection

For gnomAD samples, the script compares v4 vs v5 ancestry assignments to identify samples that have changed population labels. This is important because:

- Ancestry changes affect frequency calculations
- Population-specific metrics need recalculation
- Quality control may differ between populations

### Multi-Dataset Support

The script handles both gnomAD and All of Us datasets:

- **gnomAD**: Focuses on samples removed due to relatedness and ancestry changes
- **All of Us**: Identifies samples that will be filtered based on QC criteria
- **Joint analysis**: Merges results from both datasets

## Usage

### Basic Frequency Calculation

```bash
python gnomad_qc/v5/annotations/generate_frequency.py \
    --run-frequency-calculations \
    --data-set gnomad \
    --overwrite
```

### All of Us Dataset

```bash
python gnomad_qc/v5/annotations/generate_frequency.py \
    --run-frequency-calculations \
    --data-set aou \
    --overwrite
```

### Merge Datasets

```bash
python gnomad_qc/v5/annotations/generate_frequency.py \
    --merge-datasets \
    --overwrite
```

### Testing Mode

```bash
python gnomad_qc/v5/annotations/generate_frequency.py \
    --run-frequency-calculations \
    --data-set gnomad \
    --test \
    --overwrite
```

## Output Files

The script generates several output files:

- `{dataset}_freq.ht`: Frequency data for removed samples
- `{dataset}_age_hist.ht`: Age histograms for removed samples
- `{dataset}_ancestry_changes.ht`: Frequency data for samples with ancestry changes
- `joint_freq.ht`: Merged frequency data from both datasets

## Methodology

### Sample Identification

1. **Relatedness filtering**: Uses the `related_samples_to_drop` resource to identify samples that will be removed due to relatedness
2. **Ancestry changes**: Compares v4 vs v5 ancestry assignments to identify population label changes
3. **QC filtering**: For All of Us, identifies samples that fail QC criteria

### Frequency Calculation

1. **Stratification**: Builds frequency stratification based on:
   - Sex karyotype (XX/XY)
   - Genetic ancestry (pop)
   - Dataset identifier (gnomad/aou)
   - Additional strata (ancestry changes, etc.)

2. **Group membership**: Generates frequency group membership arrays for efficient computation

3. **Frequency computation**: Calculates AC, AN, AF, and homozygote counts for each stratum

### Age Histograms

1. **Age distribution**: Calculates age histograms for heterozygous and homozygous variants
2. **Sex adjustment**: Accounts for sex-specific age distributions
3. **Quality metrics**: Integrates with quality histograms for comprehensive analysis

## Dependencies

- Coverage computation output (AN data)
- Relatedness analysis results
- v4 metadata (for ancestry comparison)
- Joint QC MatrixTable
- Sample metadata with ancestry and sex information

## Future Enhancements

- Integration with v4 metadata resources
- Coverage data resource loading
- Additional QC criteria for All of Us samples
- Enhanced ancestry change detection
- Performance optimizations for large datasets

## Notes

- The script uses a differential approach to minimize computational requirements
- Coverage data integration ensures accurate AN calculations
- Ancestry change detection is critical for population-specific metrics
- The approach scales well for large datasets by focusing on differences
