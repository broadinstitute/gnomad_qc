# gnomAD v5 Frequency Calculation

This directory contains scripts for calculating variant frequencies and generating age histograms for gnomAD v5.

## Overview

The v5 frequency calculation uses a differential analysis approach to avoid densifying the full dataset. The script:

1. **Loads the gnomAD v4 frequency HT** as the base dataset
2. **Identifies samples that will be removed from v5** due to relatedness filtering
3. **Calculates frequency statistics for removed samples only** using the full dataset
4. **Subtracts the removed samples' call statistics** from the v4 frequency HT using `merge_freq_arrays` with `operation="diff"`
5. **Handles samples that change ancestry** between v4 and v5
6. **Processes All of Us samples that will be filtered out** based on QC criteria

This approach ensures we work with **all variants** from the v4 frequency HT, not just those in the joint QC MatrixTable.

## Key Features

### Differential Analysis Approach

The script uses the v4 frequency HT as the base and modifies call statistics for samples that will be removed or have changed characteristics. This approach:

- **Loads v4 frequency HT** as the base dataset containing all variants
- **Calculates frequency statistics for removed samples only** using the full dataset
- **Subtracts removed samples' call statistics** from v4 frequency HT using gnomAD's `merge_freq_arrays` with `operation="diff"`
- Reduces computational requirements by avoiding full dataset densification
- Focuses on the differential changes between v4 and v5
- Ensures all variants from v4 are processed, not just joint QC variants

### Coverage Integration

The script integrates with the coverage computation output to use AN (allele number) data generated by the coverage script. This ensures accurate frequency calculations that account for:

- Sample filtering effects on allele numbers
- Coverage-based quality metrics
- Reference genome coverage statistics

### Ancestry Change Detection

For gnomAD samples, the script compares v4 vs v5 ancestry assignments to identify samples that have changed population labels. This is important because:

- Ancestry changes affect frequency calculations
- Population-specific metrics need recalculation
- Quality control may differ between populations

### Multi-Dataset Support

The script handles both gnomAD and All of Us datasets:

- **gnomAD**: Focuses on samples removed due to relatedness and ancestry changes
- **All of Us**: Identifies samples that will be filtered based on QC criteria
- **Joint analysis**: Merges results from both datasets

## Usage

### Basic Frequency Calculation

```bash
python gnomad_qc/v5/annotations/generate_frequency.py \
    --run-frequency-calculations \
    --data-set gnomad \
    --overwrite
```

### All of Us Dataset

```bash
python gnomad_qc/v5/annotations/generate_frequency.py \
    --run-frequency-calculations \
    --data-set aou \
    --overwrite
```

### Merge Datasets

```bash
python gnomad_qc/v5/annotations/generate_frequency.py \
    --merge-datasets \
    --overwrite
```

### Testing Mode

```bash
python gnomad_qc/v5/annotations/generate_frequency.py \
    --run-frequency-calculations \
    --data-set gnomad \
    --test \
    --overwrite
```

## Output Files

The script generates several output files:

- `{dataset}_freq.ht`: Frequency data for removed samples
- `{dataset}_age_hist.ht`: Age histograms for removed samples
- `{dataset}_ancestry_changes.ht`: Frequency data for samples with ancestry changes
- `joint_freq.ht`: Merged frequency data from both datasets

## Methodology

### Sample Identification

1. **Relatedness filtering**: Uses the `related_samples_to_drop` resource to identify samples that will be removed due to relatedness
2. **Ancestry changes**: Compares v4 vs v5 ancestry assignments to identify population label changes
3. **QC filtering**: For All of Us, identifies samples that fail QC criteria

### Frequency Calculation

1. **Base Dataset**: Loads gnomAD v4 frequency HT as the base dataset containing all variants
2. **Removed Samples**: Calculates frequency statistics for samples that will be removed using the full dataset
3. **Differential Subtraction**: Subtracts removed samples' call statistics from v4 frequency HT using `merge_freq_arrays` with `operation="diff"`
4. **Stratification**: Builds frequency stratification based on:
   - Sex karyotype (XX/XY)
   - Genetic ancestry (pop)
   - Dataset identifier (gnomad/aou)
   - Additional strata (ancestry changes, etc.)

2. **Group membership**: Generates frequency group membership arrays for efficient computation

3. **Frequency computation**: Calculates AC, AN, AF, and homozygote counts for each stratum

### Age Histograms

1. **Age distribution**: Calculates age histograms for heterozygous and homozygous variants
2. **Sex adjustment**: Accounts for sex-specific age distributions
3. **Quality metrics**: Integrates with quality histograms for comprehensive analysis

## Dependencies

- Coverage computation output (AN data)
- Relatedness analysis results
- v4 metadata (for ancestry comparison)
- Joint QC MatrixTable
- Sample metadata with ancestry and sex information

## Future Enhancements

- Integration with v4 metadata resources
- Coverage data resource loading
- Additional QC criteria for All of Us samples
- Enhanced ancestry change detection
- Performance optimizations for large datasets

## Notes

- The script uses a differential approach to minimize computational requirements
- Coverage data integration ensures accurate AN calculations
- Ancestry change detection is critical for population-specific metrics
- The approach scales well for large datasets by focusing on differences
