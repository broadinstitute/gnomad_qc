<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>gnomad_qc.v5.data_ingestion.federated_validity_checks &mdash; gnomad_qc master documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
        <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            gnomad_qc
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/broadinstitute/gnomad_qc/tags">Change Log</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">gnomad_qc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">gnomad_qc.v5.data_ingestion.federated_validity_checks</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for gnomad_qc.v5.data_ingestion.federated_validity_checks</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Script to perform validity checks on input federated data or final release files.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">hail</span> <span class="k">as</span> <span class="nn">hl</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">gnomad.assessment.parse_validity_logs</span> <span class="kn">import</span> <span class="n">generate_html_report</span><span class="p">,</span> <span class="n">parse_log_file</span>
<span class="kn">from</span> <span class="nn">gnomad.assessment.validity_checks</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">check_global_and_row_annot_lengths</span><span class="p">,</span>
    <span class="n">check_globals_for_retired_terms</span><span class="p">,</span>
    <span class="n">check_missingness_of_struct</span><span class="p">,</span>
    <span class="n">check_raw_and_adj_callstats</span><span class="p">,</span>
    <span class="n">check_sex_chr_metrics</span><span class="p">,</span>
    <span class="n">compare_subset_freqs</span><span class="p">,</span>
    <span class="n">compute_missingness</span><span class="p">,</span>
    <span class="n">flatten_missingness_struct</span><span class="p">,</span>
    <span class="n">sum_group_callstats</span><span class="p">,</span>
    <span class="n">summarize_variant_filters</span><span class="p">,</span>
    <span class="n">summarize_variants</span><span class="p">,</span>
    <span class="n">unfurl_array_annotations</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">gnomad.resources.grch38.gnomad</span> <span class="kn">import</span> <span class="n">public_release</span>
<span class="kn">from</span> <span class="nn">gnomad.utils.reference_genome</span> <span class="kn">import</span> <span class="n">get_reference_genome</span>
<span class="kn">from</span> <span class="nn">jsonschema</span> <span class="kn">import</span> <span class="n">validate</span>
<span class="kn">from</span> <span class="nn">jsonschema.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>

<span class="kn">from</span> <span class="nn">gnomad_qc.v4.create_release.validate_and_export_vcf</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ALLELE_TYPE_FIELDS</span><span class="p">,</span>
    <span class="n">REGION_FLAG_FIELDS</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">gnomad_qc.v5.configs.validity_inputs_schema</span> <span class="kn">import</span> <span class="n">schema</span>
<span class="kn">from</span> <span class="nn">gnomad_qc.v5.resources.basics</span> <span class="kn">import</span> <span class="n">get_logging_path</span>

<span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>


<span class="c1"># Configure the root logger for terminal output.</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(levelname)s</span><span class="s2"> (</span><span class="si">%(module)s</span><span class="s2">.</span><span class="si">%(funcName)s</span><span class="s2"> </span><span class="si">%(lineno)d</span><span class="s2">): </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Create an in-memory stream for logging.</span>
<span class="n">log_stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;gnomad.assessment.validity_checks&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># Create a stream handler for in-memory logging.</span>
<span class="n">memory_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">log_stream</span><span class="p">)</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
    <span class="s2">&quot;</span><span class="si">%(levelname)s</span><span class="s2"> (</span><span class="si">%(module)s</span><span class="s2">.</span><span class="si">%(funcName)s</span><span class="s2"> </span><span class="si">%(lineno)d</span><span class="s2">): </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
<span class="p">)</span>
<span class="n">memory_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">memory_handler</span><span class="p">)</span>

<span class="n">ALLELE_TYPE_FIELDS</span> <span class="o">=</span> <span class="n">ALLELE_TYPE_FIELDS</span><span class="p">[</span><span class="s2">&quot;genomes&quot;</span><span class="p">]</span>
<span class="n">REGION_FLAG_FIELDS</span> <span class="o">=</span> <span class="n">REGION_FLAG_FIELDS</span><span class="p">[</span><span class="s2">&quot;genomes&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="get_table_kind"><a class="viewcode-back" href="../../../../api_reference/v5/data_ingestion/federated_validity_checks.html#gnomad_qc.v5.data_ingestion.federated_validity_checks.get_table_kind">[docs]</a><span class="k">def</span> <span class="nf">get_table_kind</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">header_index</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine whether a markdown table corresponds to &quot;global&quot; or &quot;row&quot; fields by scanning upward from the table header line.</span>

<span class="sd">    :param lines: The full list of lines from the markdown document.</span>
<span class="sd">    :param header_index: The index of the table header line (the line with column names).</span>
<span class="sd">    :return: String &#39;global&#39; if the nearest preceding section marker indicates global fields, &#39;row&#39; if it indicates row fields, or &#39;None&#39; if neither is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">header_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">prev_line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prev_line</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="s2">&quot;global&quot;</span> <span class="ow">in</span> <span class="n">prev_line</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;global&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;row&quot;</span> <span class="ow">in</span> <span class="n">prev_line</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;row&quot;</span>
        <span class="c1"># Stop if hit a heading.</span>
        <span class="k">if</span> <span class="n">prev_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="hail_type_from_string"><a class="viewcode-back" href="../../../../api_reference/v5/data_ingestion/federated_validity_checks.html#gnomad_qc.v5.data_ingestion.federated_validity_checks.hail_type_from_string">[docs]</a><span class="k">def</span> <span class="nf">hail_type_from_string</span><span class="p">(</span><span class="n">type_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a type string from the markdown to a Hail type.</span>

<span class="sd">    This function expects flattened fields (no nested dicts or nested structs).</span>
<span class="sd">    Complex nested types may not be fully supported.</span>

<span class="sd">    :param type_str: Type string from markdown text, such as `int32`.</span>
<span class="sd">    :return: Hail type represented by the type string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">type_str</span> <span class="o">=</span> <span class="n">type_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;`&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">type_str</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;int64&quot;</span><span class="p">}:</span>
        <span class="k">return</span> <span class="n">hl</span><span class="o">.</span><span class="n">tint64</span>
    <span class="k">elif</span> <span class="n">type_str</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;int32&quot;</span><span class="p">}:</span>
        <span class="k">return</span> <span class="n">hl</span><span class="o">.</span><span class="n">tint32</span>
    <span class="k">elif</span> <span class="n">type_str</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;float64&quot;</span><span class="p">}:</span>
        <span class="k">return</span> <span class="n">hl</span><span class="o">.</span><span class="n">tfloat64</span>
    <span class="k">elif</span> <span class="n">type_str</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;float32&quot;</span><span class="p">}:</span>
        <span class="k">return</span> <span class="n">hl</span><span class="o">.</span><span class="n">tfloat32</span>
    <span class="k">elif</span> <span class="n">type_str</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">}:</span>
        <span class="k">return</span> <span class="n">hl</span><span class="o">.</span><span class="n">tstr</span>
    <span class="k">elif</span> <span class="n">type_str</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;bool&quot;</span><span class="p">,</span> <span class="s2">&quot;boolean&quot;</span><span class="p">}:</span>
        <span class="k">return</span> <span class="n">hl</span><span class="o">.</span><span class="n">tbool</span>
    <span class="k">elif</span> <span class="n">type_str</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;locus&lt;GRCh38&gt;&quot;</span><span class="p">}:</span>
        <span class="k">return</span> <span class="n">hl</span><span class="o">.</span><span class="n">tlocus</span><span class="p">(</span><span class="s2">&quot;GRCh38&quot;</span><span class="p">)</span>

    <span class="c1"># Handle arrays.</span>
    <span class="n">array_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;array&lt;(.+)&gt;&quot;</span><span class="p">,</span> <span class="n">type_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">array_match</span><span class="p">:</span>
        <span class="n">inner_type</span> <span class="o">=</span> <span class="n">hail_type_from_string</span><span class="p">(</span><span class="n">array_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hl</span><span class="o">.</span><span class="n">tarray</span><span class="p">(</span><span class="n">inner_type</span><span class="p">)</span>

    <span class="c1"># Handle sets.</span>
    <span class="n">set_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;set&lt;(.+)&gt;&quot;</span><span class="p">,</span> <span class="n">type_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">set_match</span><span class="p">:</span>
        <span class="n">inner_type</span> <span class="o">=</span> <span class="n">hail_type_from_string</span><span class="p">(</span><span class="n">set_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hl</span><span class="o">.</span><span class="n">tset</span><span class="p">(</span><span class="n">inner_type</span><span class="p">)</span>

    <span class="c1"># Handle dictionaries.</span>
    <span class="n">dict_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;dict&lt;(.+),\s*(.+)&gt;&quot;</span><span class="p">,</span> <span class="n">type_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dict_match</span><span class="p">:</span>
        <span class="n">key_type</span> <span class="o">=</span> <span class="n">hail_type_from_string</span><span class="p">(</span><span class="n">dict_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">value_type</span> <span class="o">=</span> <span class="n">hail_type_from_string</span><span class="p">(</span><span class="n">dict_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hl</span><span class="o">.</span><span class="n">tdict</span><span class="p">(</span><span class="n">key_type</span><span class="p">,</span> <span class="n">value_type</span><span class="p">)</span>

    <span class="c1"># Handle structs (if type is struct, it will always be a parent type for</span>
    <span class="c1"># which we can skip obtaining the type).</span>
    <span class="k">if</span> <span class="n">type_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;struct&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">hl</span><span class="o">.</span><span class="n">tstruct</span><span class="p">()</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized type string: </span><span class="si">{</span><span class="n">type_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_concrete_type"><a class="viewcode-back" href="../../../../api_reference/v5/data_ingestion/federated_validity_checks.html#gnomad_qc.v5.data_ingestion.federated_validity_checks.is_concrete_type">[docs]</a><span class="k">def</span> <span class="nf">is_concrete_type</span><span class="p">(</span><span class="n">htype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine whether a Hail type represents a &quot;concrete&quot; field that should be added to field_types, as opposed to an empty container (such as an empty array or struct).</span>

<span class="sd">    Empty structs and arrays are not concrete types. Arrays are interpreted recursively.</span>

<span class="sd">    :param htype: Hail type to check (ex: hl.tint32, hl.tarray(hl.tfloat64), hl.tstruct()).</span>
<span class="sd">    :return: Bool of whether or not the hail type is considered &quot;concrete&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">htype</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">tstruct</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">htype</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">htype</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">tarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">is_concrete_type</span><span class="p">(</span><span class="n">htype</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="parse_field_necessity_from_md"><a class="viewcode-back" href="../../../../api_reference/v5/data_ingestion/federated_validity_checks.html#gnomad_qc.v5.data_ingestion.federated_validity_checks.parse_field_necessity_from_md">[docs]</a><span class="k">def</span> <span class="nf">parse_field_necessity_from_md</span><span class="p">(</span>
    <span class="n">md_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create dictionary of field necessity from parsing markdown text.</span>

<span class="sd">    :param md_text: Markdown text to parse.</span>
<span class="sd">    :return: Dictionary of field names and their necessity, and dictionary split into &#39;global_field_types&#39; and &#39;row_field_types&#39; keys, containing field names and their types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field_necessities</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">field_types</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;global_field_types&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;row_field_types&quot;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">md_text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">in_table</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">parent_types</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="c1"># Detect table header to distinguish between global and row fields.</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;| Field&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Field Necessity&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">in_table</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">table_kind</span> <span class="o">=</span> <span class="n">get_table_kind</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Skip alignment row.</span>
        <span class="k">if</span> <span class="n">in_table</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\|[-| ]+\|$&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># Process table rows.</span>
        <span class="k">elif</span> <span class="n">in_table</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
            <span class="n">field_raw</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">field_type</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">necessity</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Strip HTML tags and extra formatting.</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">field_raw</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[*`]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># Convert the types in string format to hail types.</span>
            <span class="n">field_type</span> <span class="o">=</span> <span class="n">hail_type_from_string</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>

            <span class="n">field_parts</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="c1"># Keep track of parent fields in the &#39;parent_types&#39; dictionary.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">parent_types</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_type</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">field_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">parent_type</span> <span class="o">=</span> <span class="n">parent_types</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
                <span class="c1"># If the parent type of a given field is an array, wrap the field type</span>
                <span class="c1"># within tarray.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_type</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">tarray</span><span class="p">):</span>
                    <span class="n">field_type</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">tarray</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>

            <span class="c1"># Skip recording the field type if the field is a parent type with further</span>
            <span class="c1"># nodes (will be array or struct with no defined inner types).</span>
            <span class="k">if</span> <span class="n">is_concrete_type</span><span class="p">(</span><span class="n">field_type</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">table_kind</span> <span class="o">==</span> <span class="s2">&quot;global&quot;</span><span class="p">:</span>
                    <span class="n">field_types</span><span class="p">[</span><span class="s2">&quot;global_field_types&quot;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_type</span>
                <span class="k">elif</span> <span class="n">table_kind</span> <span class="o">==</span> <span class="s2">&quot;row&quot;</span><span class="p">:</span>
                    <span class="n">field_types</span><span class="p">[</span><span class="s2">&quot;row_field_types&quot;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_type</span>

            <span class="c1"># Normalize necessity label.</span>
            <span class="n">necessity_clean</span> <span class="o">=</span> <span class="n">necessity</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;required&quot;</span> <span class="ow">in</span> <span class="n">necessity_clean</span><span class="p">:</span>
                <span class="n">field_necessities</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;required&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;optional&quot;</span> <span class="ow">in</span> <span class="n">necessity_clean</span><span class="p">:</span>
                <span class="n">field_necessities</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;optional&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;not needed&quot;</span> <span class="ow">in</span> <span class="n">necessity_clean</span><span class="p">:</span>
                <span class="n">field_necessities</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not_needed&quot;</span>
        <span class="c1"># End of table.</span>
        <span class="k">elif</span> <span class="n">in_table</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">in_table</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">in_table</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">):</span>
            <span class="n">in_table</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">field_necessities</span><span class="p">,</span> <span class="n">field_types</span></div>


<div class="viewcode-block" id="log_field_validation_results"><a class="viewcode-back" href="../../../../api_reference/v5/data_ingestion/federated_validity_checks.html#gnomad_qc.v5.data_ingestion.federated_validity_checks.log_field_validation_results">[docs]</a><span class="k">def</span> <span class="nf">log_field_validation_results</span><span class="p">(</span>
    <span class="n">field_issues</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span>
    <span class="n">fields_validated</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span>
    <span class="n">type_issues</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">types_validated</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log the results of field existence and type validation.</span>

<span class="sd">    :param field_issues: Nested dictionary mapping necessity (&quot;required&quot;, &quot;optional&quot;) and annotation_kind (&quot;row&quot;, &quot;global&quot;) to list of missing field names.</span>
<span class="sd">    :param fields_validated:  Nested dictionary mapping necessity (&quot;required&quot;, &quot;optional&quot;) and annotation_kind (&quot;row&quot;, &quot;global&quot;) to list of fields successfully found.</span>
<span class="sd">    :param type_issues: List of strings describing fields with incorrect or mismatched types.</span>
<span class="sd">    :param types_validated: List of strings describing successful type validations.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Log missing fields.</span>
    <span class="k">for</span> <span class="n">necessity</span><span class="p">,</span> <span class="n">annos</span> <span class="ow">in</span> <span class="n">field_issues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">annotation_type</span><span class="p">,</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">annos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">necessity</span> <span class="o">==</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;FAILED FIELD VALIDATIONS: missing </span><span class="si">%s</span><span class="s2"> fields: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">annotation_type</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">fields</span><span class="p">)),</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">necessity</span> <span class="o">==</span> <span class="s2">&quot;optional&quot;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;MISSING optional </span><span class="si">%s</span><span class="s2"> fields: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">annotation_type</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">fields</span><span class="p">)),</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;necessity must be one of &#39;required&#39; or &#39;optional&quot;</span><span class="p">)</span>

    <span class="c1"># Log found/validated fields.</span>
    <span class="k">for</span> <span class="n">necessity</span><span class="p">,</span> <span class="n">annos</span> <span class="ow">in</span> <span class="n">fields_validated</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">annotation_type</span><span class="p">,</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">annos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Found </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> fields: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">necessity</span><span class="p">,</span>
                    <span class="n">annotation_type</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">fields</span><span class="p">)),</span>
                <span class="p">)</span>

    <span class="c1"># Log type validations.</span>
    <span class="k">if</span> <span class="n">type_issues</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Type issues: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">type_issues</span><span class="p">)),</span>
        <span class="p">)</span>

    <span class="c1"># Log type validations.</span>
    <span class="k">if</span> <span class="n">types_validated</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Validated types: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">types_validated</span><span class="p">)),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="validate_config"><a class="viewcode-back" href="../../../../api_reference/v5/data_ingestion/federated_validity_checks.html#gnomad_qc.v5.data_ingestion.federated_validity_checks.validate_config">[docs]</a><span class="k">def</span> <span class="nf">validate_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate JSON config inputs.</span>

<span class="sd">    :param config: JSON configuration for parameter inputs.</span>
<span class="sd">    :param schema: JSON schema to use for validation.</span>
<span class="sd">    :return: None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate config file against schema.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">validate</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;JSON is valid.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JSON validation error: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="validate_config_fields_in_ht"><a class="viewcode-back" href="../../../../api_reference/v5/data_ingestion/federated_validity_checks.html#gnomad_qc.v5.data_ingestion.federated_validity_checks.validate_config_fields_in_ht">[docs]</a><span class="k">def</span> <span class="nf">validate_config_fields_in_ht</span><span class="p">(</span><span class="n">ht</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that necessary fields defined in the JSON config are present in the Hail Table.</span>

<span class="sd">    :param ht: Hail Table.</span>
<span class="sd">    :param config: JSON configuration for parameter inputs.</span>
<span class="sd">    :return: None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define array struct annotations (must include frequency information as &#39;freq&#39; annotation within &#39;freq_fields&#39;, and</span>
    <span class="c1"># if filtering allele frequency is present it should be provided as &#39;faf&#39;</span>
    <span class="c1"># annotation within &#39;faf_fields&#39;).</span>
    <span class="n">array_struct_annotations</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_fields&quot;</span><span class="p">][</span><span class="s2">&quot;freq&quot;</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;faf_fields&quot;</span><span class="p">):</span>
        <span class="n">array_struct_annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;faf_fields&quot;</span><span class="p">][</span><span class="s2">&quot;faf&quot;</span><span class="p">])</span>

    <span class="c1"># Check that all necessary fields are present in the Table.</span>
    <span class="n">missing_fields</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Check that specified global annotations are present.</span>
    <span class="n">global_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_fields&quot;</span><span class="p">][</span><span class="s2">&quot;freq_meta&quot;</span><span class="p">],</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_fields&quot;</span><span class="p">][</span><span class="s2">&quot;freq_meta_sample_count&quot;</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;faf_fields&quot;</span><span class="p">):</span>
        <span class="n">global_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;faf_fields&quot;</span><span class="p">][</span><span class="s2">&quot;faf_meta&quot;</span><span class="p">])</span>

    <span class="n">missing_global_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">global_fields</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ht</span><span class="o">.</span><span class="n">globals</span><span class="p">]</span>
    <span class="n">missing_fields</span><span class="p">[</span><span class="s2">&quot;globals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_global_fields</span>

    <span class="c1"># Check that specified row annotations are present.</span>
    <span class="n">row_fields</span> <span class="o">=</span> <span class="n">array_struct_annotations</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;struct_annotations_for_missingness&quot;</span><span class="p">]</span>

    <span class="n">missing_row_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">row_fields</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ht</span><span class="o">.</span><span class="n">row</span><span class="p">]</span>
    <span class="n">missing_fields</span><span class="p">[</span><span class="s2">&quot;rows&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_row_fields</span>

    <span class="c1"># Check that specified info annotations are present.</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;check_mono_and_only_het&quot;</span><span class="p">):</span>
        <span class="n">info_annotations</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;monoallelic&quot;</span><span class="p">,</span> <span class="s2">&quot;only_het&quot;</span><span class="p">]</span>
        <span class="n">info_fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">missing_info_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">info_annotations</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info_fields</span><span class="p">]</span>
        <span class="n">missing_fields</span><span class="p">[</span><span class="s2">&quot;missing_info_fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_info_fields</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">missing_fields</span><span class="p">[</span><span class="s2">&quot;missing_info_fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Check that freq_annotations_to_sum values are present in the &#39;freq&#39; struct.</span>
    <span class="n">freq_fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">freq</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">freq_annotations</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_annotations_to_sum&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nhomalt_metric&quot;</span><span class="p">]]</span>
    <span class="n">missing_freq_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">freq_annotations</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">freq_fields</span><span class="p">]</span>
    <span class="n">missing_fields</span><span class="p">[</span><span class="s2">&quot;missing_freq_fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_freq_fields</span>

    <span class="c1"># Check that sort_order values are present as keys within freq_meta_expr.</span>
    <span class="n">freq_meta_list</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">ht</span><span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_fields&quot;</span><span class="p">][</span><span class="s2">&quot;freq_meta&quot;</span><span class="p">]])</span>
    <span class="n">freq_meta_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">key</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">freq_meta_list</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">missing_sort_order_keys</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;sort_order&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">freq_meta_keys</span>
    <span class="p">]</span>
    <span class="n">missing_fields</span><span class="p">[</span><span class="s2">&quot;missing_sort_order_keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_sort_order_keys</span>

    <span class="c1"># Check that specified subsets are present as values within the</span>
    <span class="c1"># freq_meta_expr subset key.</span>
    <span class="n">subset_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;subset&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">freq_meta_list</span> <span class="k">if</span> <span class="s2">&quot;subset&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">}</span>
    <span class="n">subsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">subset</span> <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subsets&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">subset</span><span class="p">]</span>
    <span class="n">missing_subsets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">subsets</span><span class="p">)</span> <span class="o">-</span> <span class="n">subset_values</span>
    <span class="n">missing_fields</span><span class="p">[</span><span class="s2">&quot;missing_subsets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_subsets</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">missing_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;Validation failed. Missing fields:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">missing_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validated presence of config fields in the Table.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="validate_required_fields"><a class="viewcode-back" href="../../../../api_reference/v5/data_ingestion/federated_validity_checks.html#gnomad_qc.v5.data_ingestion.federated_validity_checks.validate_required_fields">[docs]</a><span class="k">def</span> <span class="nf">validate_required_fields</span><span class="p">(</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span>
    <span class="n">field_types</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">field_necessities</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">validate_all_fields</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate that the table contains the required global and row fields and that their values are of the expected types.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Required fields can be nested (e.g., &#39;info.QD&#39; indicates that the &#39;QD&#39; field is nested within the &#39;info&#39; struct).</span>

<span class="sd">    :param ht: Table to validate.</span>
<span class="sd">    :param field_types: Nested dictionary of both global and row fields and their expected types. There are two keys: &quot;global_field_types&quot; and &quot;row_field_types&quot;, respectively containing the global and row fields as keys and their expected types as values.</span>
<span class="sd">    :param field_necessities: Flat dictionary with annotation fields as keys and values field necessity(&quot;required&quot; or &quot;optional&quot;) as values.</span>
<span class="sd">    :param validate_all_fields: Whether to validate all fields or only the required/optional ones.</span>
<span class="sd">    :return: Tuple of fields checked and whether or not they passed validation checks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field_issues</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
    <span class="n">type_issues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fields_validated</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
    <span class="n">types_validated</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">default_necessity</span> <span class="o">=</span> <span class="s2">&quot;not_needed&quot;</span>

    <span class="c1"># If validate_all_fields is True, set all field necessities to &quot;required&quot;.</span>
    <span class="k">if</span> <span class="n">validate_all_fields</span><span class="p">:</span>
        <span class="n">field_necessities</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="s2">&quot;required&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">field_necessities</span><span class="p">}</span>
        <span class="n">default_necessity</span> <span class="o">=</span> <span class="s2">&quot;required&quot;</span>

    <span class="k">def</span> <span class="nf">_check_field_exists_and_type</span><span class="p">(</span>
        <span class="n">root_expr</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">Expression</span><span class="p">,</span>
        <span class="n">field_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">expected_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">annotation_kind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;row&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that the field exists and is of the expected type.</span>

<span class="sd">        :param root_expr: Root expression to check.</span>
<span class="sd">        :param field_path: Path to the field to check, where a period indicates a nested field.</span>
<span class="sd">        :param expected_type: Expected type of the field.</span>
<span class="sd">        :param annotation_kind: Kind of annotation to check (&quot;row&quot; or &quot;global&quot;).</span>
<span class="sd">        :return: None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">field_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">current_field</span> <span class="o">=</span> <span class="n">root_expr</span>

        <span class="n">field_necessity</span> <span class="o">=</span> <span class="n">field_necessities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_path</span><span class="p">,</span> <span class="n">default_necessity</span><span class="p">)</span>

        <span class="c1"># Unless specified, only check optional and required fields.</span>
        <span class="k">if</span> <span class="n">field_necessity</span> <span class="o">==</span> <span class="s2">&quot;not_needed&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">current_field</span><span class="o">.</span><span class="n">dtype</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">tstruct</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                    <span class="n">field_issues</span><span class="p">[</span><span class="n">field_necessity</span><span class="p">][</span><span class="n">annotation_kind</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_path</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">current_field</span> <span class="o">=</span> <span class="n">current_field</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">tarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">dtype</span><span class="o">.</span><span class="n">element_type</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">tstruct</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">element_type</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                    <span class="n">field_issues</span><span class="p">[</span><span class="n">field_necessity</span><span class="p">][</span><span class="n">annotation_kind</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_path</span><span class="si">}</span><span class="s2"> (available in array struct: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">element_type</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">current_field</span> <span class="o">=</span> <span class="n">current_field</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">part</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Unsupported type while traversing </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="n">i</span><span class="p">]),</span>
                    <span class="n">dtype</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># If we make it here, the field exists fully.</span>
        <span class="n">fields_validated</span><span class="p">[</span><span class="n">field_necessity</span><span class="p">][</span><span class="n">annotation_kind</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_path</span><span class="p">)</span>

        <span class="c1"># Check that the field type matches expectation.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected_type</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">tarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">current_field</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">tarray</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">expected_type</span><span class="o">.</span><span class="n">element_type</span> <span class="o">!=</span> <span class="n">current_field</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">element_type</span><span class="p">:</span>
                <span class="n">type_issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_kind</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> field &#39;</span><span class="si">{</span><span class="n">field_path</span><span class="si">}</span><span class="s2">&#39; is an array with incorrect element type: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;expected </span><span class="si">{</span><span class="n">expected_type</span><span class="o">.</span><span class="n">element_type</span><span class="si">}</span><span class="s2">, found </span><span class="si">{</span><span class="n">current_field</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">element_type</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">types_validated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_kind</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> field &#39;</span><span class="si">{</span><span class="n">field_path</span><span class="si">}</span><span class="s2">&#39; IS an array with correct element type </span><span class="si">{</span><span class="n">expected_type</span><span class="o">.</span><span class="n">element_type</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_field</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">expected_type</span><span class="p">:</span>
                <span class="n">type_issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_kind</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> field &#39;</span><span class="si">{</span><span class="n">field_path</span><span class="si">}</span><span class="s2">&#39; is not of type </span><span class="si">{</span><span class="n">expected_type</span><span class="si">}</span><span class="s2">, found </span><span class="si">{</span><span class="n">current_field</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">types_validated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation_kind</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> field &#39;</span><span class="si">{</span><span class="n">field_path</span><span class="si">}</span><span class="s2">&#39; IS of expected type </span><span class="si">{</span><span class="n">expected_type</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Validate global fields.</span>
    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">expected_type</span> <span class="ow">in</span> <span class="n">field_types</span><span class="p">[</span><span class="s2">&quot;global_field_types&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_check_field_exists_and_type</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">globals</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">expected_type</span><span class="p">,</span> <span class="s2">&quot;global&quot;</span><span class="p">)</span>

    <span class="c1"># Validate row fields.</span>
    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">expected_type</span> <span class="ow">in</span> <span class="n">field_types</span><span class="p">[</span><span class="s2">&quot;row_field_types&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_check_field_exists_and_type</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">expected_type</span><span class="p">,</span> <span class="s2">&quot;row&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">field_issues</span><span class="p">,</span> <span class="n">type_issues</span><span class="p">,</span> <span class="n">fields_validated</span><span class="p">,</span> <span class="n">types_validated</span></div>


<div class="viewcode-block" id="check_missingness"><a class="viewcode-back" href="../../../../api_reference/v5/data_ingestion/federated_validity_checks.html#gnomad_qc.v5.data_ingestion.federated_validity_checks.check_missingness">[docs]</a><span class="k">def</span> <span class="nf">check_missingness</span><span class="p">(</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span>
    <span class="n">missingness_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">struct_annotations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;grpmax&quot;</span><span class="p">,</span> <span class="s2">&quot;fafmax&quot;</span><span class="p">,</span> <span class="s2">&quot;histograms&quot;</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check for and report the fraction of missing data in the Table.</span>

<span class="sd">    :param ht: Input Table.</span>
<span class="sd">    :param missingness_threshold: Upper cutoff for allowed amount of missingness. Default is 0.50.</span>
<span class="sd">    :param struct_annotations: List of struct annotations to check for missingness. Default is [&#39;grpmax&#39;, &#39;fafmax&#39;, &#39;histograms&#39;].</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking for missingness within struct annotations...&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Struct annotations being checked: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">struct_annotations</span><span class="p">)</span>
    <span class="c1"># Determine missingness of each struct annotation.</span>
    <span class="n">metric_missingness</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">struct_annotations</span><span class="p">:</span>
        <span class="n">metric_missingness</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">check_missingness_of_struct</span><span class="p">(</span><span class="n">ht</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">metric</span><span class="p">))</span>

    <span class="n">missingness_struct</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="o">**</span><span class="n">metric_missingness</span><span class="p">))</span>
    <span class="n">missingness_dict</span> <span class="o">=</span> <span class="n">flatten_missingness_struct</span><span class="p">(</span><span class="n">missingness_struct</span><span class="p">)</span>

    <span class="c1"># Report whether or not each metric pass or fails the missingness check</span>
    <span class="c1"># based on the missingness_threshold.</span>
    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">missingness</span> <span class="ow">in</span> <span class="n">missingness_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">missingness</span> <span class="o">&gt;</span> <span class="n">missingness_threshold</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;FAILED missingness check for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%.2f%%</span><span class="s2"> missing&quot;</span><span class="p">,</span>
                <span class="n">field</span><span class="p">,</span>
                <span class="mi">100</span> <span class="o">*</span> <span class="n">missingness</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Passed missingness check for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%.2f%%</span><span class="s2"> missing&quot;</span><span class="p">,</span>
                <span class="n">field</span><span class="p">,</span>
                <span class="mi">100</span> <span class="o">*</span> <span class="n">missingness</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking for missingness of info and non-info fields...&quot;</span><span class="p">)</span>
    <span class="c1"># Gather info and non-info metrics (or if doesn&#39;t exist, set to an empty list)</span>
    <span class="c1"># and substract missingness dict.</span>
    <span class="n">info_metrics</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">info</span><span class="p">)</span> <span class="o">-</span> <span class="n">missingness_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;info&quot;</span> <span class="ow">in</span> <span class="n">ht</span><span class="o">.</span><span class="n">row</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">non_info_metrics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">row</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;info&quot;</span><span class="p">}</span> <span class="o">-</span> <span class="n">missingness_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">n_sites</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Info metrics are </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">info_metrics</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Non-info metrics are </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">non_info_metrics</span><span class="p">)</span>
    <span class="n">compute_missingness</span><span class="p">(</span>
        <span class="n">ht</span><span class="p">,</span> <span class="n">info_metrics</span><span class="p">,</span> <span class="n">non_info_metrics</span><span class="p">,</span> <span class="n">n_sites</span><span class="p">,</span> <span class="n">missingness_threshold</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="validate_federated_data"><a class="viewcode-back" href="../../../../api_reference/v5/data_ingestion/federated_validity_checks.html#gnomad_qc.v5.data_ingestion.federated_validity_checks.validate_federated_data">[docs]</a><span class="k">def</span> <span class="nf">validate_federated_data</span><span class="p">(</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span>
    <span class="n">freq_meta_expr</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">ArrayExpression</span><span class="p">,</span>
    <span class="n">missingness_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.50</span><span class="p">,</span>
    <span class="n">struct_annotations_for_missingness</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;grpmax&quot;</span><span class="p">,</span> <span class="s2">&quot;fafmax&quot;</span><span class="p">,</span> <span class="s2">&quot;histograms&quot;</span><span class="p">],</span>
    <span class="n">freq_annotations_to_sum</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AC&quot;</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">],</span>
    <span class="n">sort_order</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;subset&quot;</span><span class="p">,</span> <span class="s2">&quot;downsampling&quot;</span><span class="p">,</span> <span class="s2">&quot;gen_anc&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">],</span>
    <span class="n">nhomalt_metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;nhomalt&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">subsets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">variant_filter_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AS_VQSR&quot;</span><span class="p">,</span>
    <span class="n">problematic_regions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lcr&quot;</span><span class="p">,</span> <span class="s2">&quot;non_par&quot;</span><span class="p">,</span> <span class="s2">&quot;segdup&quot;</span><span class="p">],</span>
    <span class="n">site_gt_check_expr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">hl</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">BooleanExpression</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform validity checks on federated data.</span>

<span class="sd">    :param ht: Input Table.</span>
<span class="sd">    :param freq_meta_expr: Metadata expression that contains the values of the elements in</span>
<span class="sd">        `meta_indexed_expr`. The most often used expression is `freq_meta` to index into</span>
<span class="sd">        a &#39;freq&#39; array (example: ht.freq_meta).</span>
<span class="sd">    :param freq_annotations_to_sum: List of annotation fields within `meta_expr` to sum. Default is [&#39;AC&#39;, &#39;AN&#39;, &#39;homozygote_count&#39;].</span>
<span class="sd">    :param sort_order: Order in which groupings are unfurled into flattened annotations. Default is [&quot;subset&quot;, &quot;downsampling&quot;, gen_anc&quot;, &quot;sex&quot;, &quot;group&quot;].</span>
<span class="sd">    :param nhomalt_metric: Name of metric denoting homozygous alternate count. Default is &quot;nhomalt&quot;.</span>
<span class="sd">    :param verbose: If True, show top values of annotations being checked, including checks that pass; if False, show only top values of annotations that fail checks. Default is False.</span>
<span class="sd">    :param subsets: List of sample subsets.</span>
<span class="sd">    :param variant_filter_field: String of variant filtration used in the filters annotation on `ht` (e.g. RF, VQSR, AS_VQSR). Default is &quot;AS_VQSR&quot;.</span>
<span class="sd">    :param problematic_regions: List of regions considered problematic to run filter check in. Default is [&quot;lcr&quot;, &quot;non_par&quot;, &quot;segdup&quot;].</span>
<span class="sd">    :param site_gt_check_expr: Optional dictionary of strings and boolean expressions typically used to log how many monoallelic or 100% heterozygous sites are in the Table.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Summarize variants and check that all contigs exist.</span>
    <span class="n">expected_contigs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;chr</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">23</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;chrX&quot;</span><span class="p">,</span> <span class="s2">&quot;chrY&quot;</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Summarizing variants and checking contigs...&quot;</span><span class="p">)</span>
    <span class="n">summarize_variants</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span> <span class="n">expected_contigs</span><span class="o">=</span><span class="n">expected_contigs</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Summarizing variant filters...&quot;</span><span class="p">)</span>
    <span class="n">summarize_variant_filters</span><span class="p">(</span>
        <span class="n">t</span><span class="o">=</span><span class="n">ht</span><span class="p">,</span>
        <span class="n">variant_filter_field</span><span class="o">=</span><span class="n">variant_filter_field</span><span class="p">,</span>
        <span class="n">problematic_regions</span><span class="o">=</span><span class="n">problematic_regions</span><span class="p">,</span>
        <span class="n">single_filter_count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">site_gt_check_expr</span><span class="o">=</span><span class="n">site_gt_check_expr</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Check for missingness.</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking for missingness...&quot;</span><span class="p">)</span>
    <span class="n">check_missingness</span><span class="p">(</span>
        <span class="n">ht</span><span class="p">,</span>
        <span class="n">missingness_threshold</span><span class="p">,</span>
        <span class="n">struct_annotations</span><span class="o">=</span><span class="n">struct_annotations_for_missingness</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Check that subset totals sum to expected totals.</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking summations...&quot;</span><span class="p">)</span>
    <span class="n">has_gen_anc</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="s2">&quot;gen_anc&quot;</span> <span class="ow">in</span> <span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">hl</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">freq_meta_expr</span><span class="p">))</span>
    <span class="n">has_pop</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="s2">&quot;pop&quot;</span> <span class="ow">in</span> <span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">hl</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">freq_meta_expr</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">has_gen_anc</span> <span class="ow">and</span> <span class="n">has_pop</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Both &#39;gen_anc&#39; and &#39;pop&#39; labels found within freq_meta_expr! Only one label can be used.&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">has_gen_anc</span><span class="p">:</span>
        <span class="n">gen_anc_label_name</span> <span class="o">=</span> <span class="s2">&quot;gen_anc&quot;</span>
    <span class="k">elif</span> <span class="n">has_pop</span><span class="p">:</span>
        <span class="n">gen_anc_label_name</span> <span class="o">=</span> <span class="s2">&quot;pop&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Neither &#39;gen_anc&#39; nor &#39;pop&#39; labels found within freq_meta_expr! One label must be used.&quot;</span>
        <span class="p">)</span>

    <span class="n">sum_group_callstats</span><span class="p">(</span>
        <span class="n">t</span><span class="o">=</span><span class="n">ht</span><span class="p">,</span>
        <span class="n">sexes</span><span class="o">=</span><span class="p">{</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hl</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">freq_meta_expr</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;sex&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">},</span>
        <span class="n">subsets</span><span class="o">=</span><span class="n">subsets</span><span class="p">,</span>
        <span class="n">gen_anc_groups</span><span class="o">=</span><span class="p">{</span>
            <span class="n">i</span><span class="p">[</span><span class="n">gen_anc_label_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hl</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">freq_meta_expr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gen_anc_label_name</span> <span class="ow">in</span> <span class="n">i</span>
        <span class="p">},</span>
        <span class="n">groups</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;adj&quot;</span><span class="p">],</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="n">sort_order</span><span class="o">=</span><span class="n">sort_order</span><span class="p">,</span>
        <span class="n">metric_first_field</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="n">freq_annotations_to_sum</span><span class="p">,</span>
        <span class="n">gen_anc_label_name</span><span class="o">=</span><span class="n">gen_anc_label_name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking sex chromosomes metrics...&quot;</span><span class="p">)</span>
    <span class="n">info_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
    <span class="n">contigs</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">agg</span><span class="o">.</span><span class="n">collect_as_set</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">locus</span><span class="o">.</span><span class="n">contig</span><span class="p">))</span>
    <span class="n">check_sex_chr_metrics</span><span class="p">(</span>
        <span class="n">t</span><span class="o">=</span><span class="n">ht</span><span class="p">,</span>
        <span class="n">info_metrics</span><span class="o">=</span><span class="n">info_metrics</span><span class="p">,</span>
        <span class="n">contigs</span><span class="o">=</span><span class="n">contigs</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="n">nhomalt_metric</span><span class="o">=</span><span class="n">nhomalt_metric</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking raw and adj callstats...&quot;</span><span class="p">)</span>
    <span class="n">check_raw_and_adj_callstats</span><span class="p">(</span>
        <span class="n">t</span><span class="o">=</span><span class="n">ht</span><span class="p">,</span>
        <span class="n">subsets</span><span class="o">=</span><span class="n">subsets</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="n">metric_first_field</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">nhomalt_metric</span><span class="o">=</span><span class="n">nhomalt_metric</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">subsets</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Comparing subset frequencies...&quot;</span><span class="p">)</span>
        <span class="n">compare_subset_freqs</span><span class="p">(</span>
            <span class="n">t</span><span class="o">=</span><span class="n">ht</span><span class="p">,</span>
            <span class="n">subsets</span><span class="o">=</span><span class="n">subsets</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">metric_first_field</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="n">freq_annotations_to_sum</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="create_logtest_ht"><a class="viewcode-back" href="../../../../api_reference/v5/data_ingestion/federated_validity_checks.html#gnomad_qc.v5.data_ingestion.federated_validity_checks.create_logtest_ht">[docs]</a><span class="k">def</span> <span class="nf">create_logtest_ht</span><span class="p">(</span><span class="n">exclude_xnonpar_y</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a test Hail Table with nested struct annotations to test log output.</span>

<span class="sd">    :param exclude_xnonpar_y: If True, exclude chrX non-pseudoautosomal region and chrY variants when making test data. Default is False.</span>
<span class="sd">    :return: Table to use for testing log output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;locus&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">locus</span><span class="p">(</span><span class="s2">&quot;chr1&quot;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">reference_genome</span><span class="o">=</span><span class="s2">&quot;GRCh38&quot;</span><span class="p">),</span>
            <span class="s2">&quot;alleles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">],</span>
            <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(),</span>
            <span class="s2">&quot;freq&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.07</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.09</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.11</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.13</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.13</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
            <span class="p">],</span>
            <span class="s2">&quot;faf&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">faf95</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">faf99</span><span class="o">=</span><span class="mf">0.002</span><span class="p">),</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">faf95</span><span class="o">=</span><span class="mf">0.0009</span><span class="p">,</span> <span class="n">faf99</span><span class="o">=</span><span class="mf">0.0018</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="s2">&quot;AS_VQSR&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;region_flags&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">lcr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">non_par</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">segdup</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;allele_info&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">allele_type</span><span class="o">=</span><span class="s2">&quot;del&quot;</span><span class="p">,</span> <span class="n">n_alt_alleles</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;locus&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">locus</span><span class="p">(</span><span class="s2">&quot;chr1&quot;</span><span class="p">,</span> <span class="mi">200000</span><span class="p">,</span> <span class="n">reference_genome</span><span class="o">=</span><span class="s2">&quot;GRCh38&quot;</span><span class="p">),</span>
            <span class="s2">&quot;alleles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">],</span>
            <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(),</span>
            <span class="s2">&quot;freq&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.50</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.18</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">95</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">],</span>
            <span class="s2">&quot;faf&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">faf95</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">faf99</span><span class="o">=</span><span class="mf">0.002</span><span class="p">),</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">faf95</span><span class="o">=</span><span class="mf">0.0009</span><span class="p">,</span> <span class="n">faf99</span><span class="o">=</span><span class="mf">0.0018</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="s2">&quot;AC0&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;region_flags&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">lcr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">non_par</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">segdup</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="s2">&quot;allele_info&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">allele_type</span><span class="o">=</span><span class="s2">&quot;snv&quot;</span><span class="p">,</span> <span class="n">n_alt_alleles</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;locus&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">locus</span><span class="p">(</span><span class="s2">&quot;chr1&quot;</span><span class="p">,</span> <span class="mi">300000</span><span class="p">,</span> <span class="n">reference_genome</span><span class="o">=</span><span class="s2">&quot;GRCh38&quot;</span><span class="p">),</span>
            <span class="s2">&quot;alleles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">],</span>
            <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(),</span>
            <span class="s2">&quot;freq&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">65</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.18</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">88</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">220</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">75</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.17</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">180</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">95</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.22</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.24</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">275</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">110</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.28</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">110</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.28</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
            <span class="p">],</span>
            <span class="s2">&quot;faf&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">faf95</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">faf99</span><span class="o">=</span><span class="mf">0.002</span><span class="p">),</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">faf95</span><span class="o">=</span><span class="mf">0.0009</span><span class="p">,</span> <span class="n">faf99</span><span class="o">=</span><span class="mf">0.0018</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">empty_set</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">tstr</span><span class="p">),</span>
            <span class="s2">&quot;region_flags&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">lcr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">non_par</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">segdup</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;allele_info&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">allele_type</span><span class="o">=</span><span class="s2">&quot;snv&quot;</span><span class="p">,</span> <span class="n">n_alt_alleles</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;locus&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">locus</span><span class="p">(</span><span class="s2">&quot;chrX&quot;</span><span class="p">,</span> <span class="mi">400000</span><span class="p">,</span> <span class="n">reference_genome</span><span class="o">=</span><span class="s2">&quot;GRCh38&quot;</span><span class="p">),</span>
            <span class="s2">&quot;alleles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">],</span>
            <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(),</span>
            <span class="s2">&quot;freq&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.18</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">75</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
            <span class="p">],</span>
            <span class="s2">&quot;faf&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">faf95</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">faf99</span><span class="o">=</span><span class="mf">0.002</span><span class="p">),</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">faf95</span><span class="o">=</span><span class="mf">0.0009</span><span class="p">,</span> <span class="n">faf99</span><span class="o">=</span><span class="mf">0.0018</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="s2">&quot;AS_VQSR&quot;</span><span class="p">,</span> <span class="s2">&quot;AC0&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;region_flags&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">lcr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">non_par</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">segdup</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="s2">&quot;allele_info&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">allele_type</span><span class="o">=</span><span class="s2">&quot;snv&quot;</span><span class="p">,</span> <span class="n">n_alt_alleles</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">exclude_xnonpar_y</span><span class="p">:</span>
        <span class="n">chry_variant</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;locus&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">locus</span><span class="p">(</span><span class="s2">&quot;chrY&quot;</span><span class="p">,</span> <span class="mi">500000</span><span class="p">,</span> <span class="n">reference_genome</span><span class="o">=</span><span class="s2">&quot;GRCh38&quot;</span><span class="p">),</span>
                <span class="s2">&quot;alleles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span>
                <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(),</span>
                <span class="s2">&quot;freq&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.18</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">65</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.22</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">55</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.27</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">65</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.33</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.23</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">44</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                <span class="p">],</span>
                <span class="s2">&quot;faf&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">faf95</span><span class="o">=</span><span class="mf">0.0012</span><span class="p">,</span> <span class="n">faf99</span><span class="o">=</span><span class="mf">0.0025</span><span class="p">),</span>
                    <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">faf95</span><span class="o">=</span><span class="mf">0.0010</span><span class="p">,</span> <span class="n">faf99</span><span class="o">=</span><span class="mf">0.0020</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="s2">&quot;AS_VQSR&quot;</span><span class="p">,</span> <span class="s2">&quot;AC0&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;region_flags&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">lcr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">non_par</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">segdup</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                <span class="s2">&quot;allele_info&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">allele_type</span><span class="o">=</span><span class="s2">&quot;del&quot;</span><span class="p">,</span> <span class="n">n_alt_alleles</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="n">chrx_nonpar_variant</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;locus&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">locus</span><span class="p">(</span><span class="s2">&quot;chrX&quot;</span><span class="p">,</span> <span class="mi">22234567</span><span class="p">,</span> <span class="n">reference_genome</span><span class="o">=</span><span class="s2">&quot;GRCh38&quot;</span><span class="p">),</span>
                <span class="s2">&quot;alleles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">],</span>
                <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(),</span>
                <span class="s2">&quot;freq&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.18</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.22</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">55</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.27</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.32</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.38</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">140</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.28</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;AC&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;AF&quot;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s2">&quot;AN&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;homozygote_count&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                <span class="p">],</span>
                <span class="s2">&quot;faf&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">faf95</span><span class="o">=</span><span class="mf">0.0013</span><span class="p">,</span> <span class="n">faf99</span><span class="o">=</span><span class="mf">0.0027</span><span class="p">),</span>
                    <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">faf95</span><span class="o">=</span><span class="mf">0.0011</span><span class="p">,</span> <span class="n">faf99</span><span class="o">=</span><span class="mf">0.0023</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="s2">&quot;AC0&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;region_flags&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">lcr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">non_par</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">segdup</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                <span class="s2">&quot;allele_info&quot;</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span><span class="n">allele_type</span><span class="o">=</span><span class="s2">&quot;del&quot;</span><span class="p">,</span> <span class="n">n_alt_alleles</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">]</span>

        <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chry_variant</span> <span class="o">+</span> <span class="n">chrx_nonpar_variant</span><span class="p">)</span>

    <span class="n">ht</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">hl</span><span class="o">.</span><span class="n">tstruct</span><span class="p">(</span>
            <span class="n">locus</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tlocus</span><span class="p">(</span><span class="n">reference_genome</span><span class="o">=</span><span class="s2">&quot;GRCh38&quot;</span><span class="p">),</span>
            <span class="n">alleles</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tarray</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">tstr</span><span class="p">),</span>
            <span class="n">info</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tstruct</span><span class="p">(),</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tarray</span><span class="p">(</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">tstruct</span><span class="p">(</span>
                    <span class="n">AC</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tint32</span><span class="p">,</span>
                    <span class="n">AF</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tfloat64</span><span class="p">,</span>
                    <span class="n">AN</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tint32</span><span class="p">,</span>
                    <span class="n">homozygote_count</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tint64</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">faf</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tarray</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">tstruct</span><span class="p">(</span><span class="n">faf95</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tfloat64</span><span class="p">,</span> <span class="n">faf99</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tfloat64</span><span class="p">)),</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tset</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">tstr</span><span class="p">),</span>
            <span class="n">region_flags</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tstruct</span><span class="p">(</span><span class="n">lcr</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tbool</span><span class="p">,</span> <span class="n">non_par</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tbool</span><span class="p">,</span> <span class="n">segdup</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tbool</span><span class="p">),</span>
            <span class="n">allele_info</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tstruct</span><span class="p">(</span><span class="n">allele_type</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tstr</span><span class="p">,</span> <span class="n">n_alt_alleles</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">tint32</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">ht</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="n">region_flags</span><span class="o">=</span><span class="n">ht</span><span class="o">.</span><span class="n">region_flags</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">fail_interval_qc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">outside_ukb_capture_region</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">outside_broad_capture_region</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">allele_info</span><span class="o">=</span><span class="n">ht</span><span class="o">.</span><span class="n">allele_info</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">variant_type</span><span class="o">=</span><span class="s2">&quot;snv&quot;</span><span class="p">,</span> <span class="n">was_mixed</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Define global annotation for freq_index_dict.</span>

    <span class="n">freq_meta</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;adj&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;raw&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;gen_anc&quot;</span><span class="p">:</span> <span class="s2">&quot;afr&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;adj&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;gen_anc&quot;</span><span class="p">:</span> <span class="s2">&quot;amr&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;adj&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="s2">&quot;XX&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;adj&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="s2">&quot;XY&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;adj&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;subset&quot;</span><span class="p">:</span> <span class="s2">&quot;non_ukb&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;adj&quot;</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="n">faf_meta</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;adj&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;raw&quot;</span><span class="p">}]</span>

    <span class="n">freq_meta_sample_count</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">]</span>
    <span class="n">faf_meta_sample_count</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>

    <span class="n">ht</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">annotate_globals</span><span class="p">(</span>
        <span class="n">freq_meta</span><span class="o">=</span><span class="n">freq_meta</span><span class="p">,</span>
        <span class="n">faf_meta</span><span class="o">=</span><span class="n">faf_meta</span><span class="p">,</span>
        <span class="n">freq_meta_sample_count</span><span class="o">=</span><span class="n">freq_meta_sample_count</span><span class="p">,</span>
        <span class="n">faf_meta_sample_count</span><span class="o">=</span><span class="n">faf_meta_sample_count</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Add in retired terms to globals.</span>
    <span class="n">ht</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">annotate_globals</span><span class="p">(</span>
        <span class="n">test_meta</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;adj&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;adj&quot;</span><span class="p">,</span> <span class="s2">&quot;pop&quot;</span><span class="p">:</span> <span class="s2">&quot;oth&quot;</span><span class="p">}]</span>
    <span class="p">)</span>

    <span class="c1"># Add grpmax and fafmax annotations.</span>
    <span class="n">grpmax</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
        <span class="n">gnomad</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
            <span class="n">AC</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">or_missing</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">rand_bool</span><span class="p">(</span><span class="mf">0.8</span><span class="p">),</span> <span class="n">hl</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">freq</span><span class="o">.</span><span class="n">AC</span><span class="p">)),</span>
            <span class="n">AF</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">or_missing</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">rand_bool</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">hl</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">freq</span><span class="o">.</span><span class="n">AF</span><span class="p">)),</span>
            <span class="n">AN</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">or_missing</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">rand_bool</span><span class="p">(</span><span class="mf">0.7</span><span class="p">),</span> <span class="n">hl</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">freq</span><span class="o">.</span><span class="n">AN</span><span class="p">)),</span>
            <span class="n">homozygote_count</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">or_missing</span><span class="p">(</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">rand_bool</span><span class="p">(</span><span class="mf">0.3</span><span class="p">),</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">freq</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">hl</span><span class="o">.</span><span class="n">or_else</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">homozygote_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">))),</span>
            <span class="p">),</span>
            <span class="n">gen_anc</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">or_missing</span><span class="p">(</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">rand_bool</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span>
                    <span class="n">hl</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span>
                        <span class="n">ht</span><span class="o">.</span><span class="n">freq</span><span class="o">.</span><span class="n">AC</span><span class="p">,</span> <span class="n">ht</span><span class="o">.</span><span class="n">freq</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gen_anc&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">freq</span><span class="o">.</span><span class="n">AC</span><span class="p">)),</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">fafmax</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
        <span class="n">gnomad</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">struct</span><span class="p">(</span>
            <span class="n">faf95_max</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">or_missing</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">rand_bool</span><span class="p">(</span><span class="mf">0.10</span><span class="p">),</span> <span class="n">hl</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">faf</span><span class="o">.</span><span class="n">faf95</span><span class="p">)),</span>
            <span class="n">faf95_max_gen_anc</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">or_missing</span><span class="p">(</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">rand_bool</span><span class="p">(</span><span class="mf">0.75</span><span class="p">),</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span>
                    <span class="n">hl</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span>
                        <span class="n">ht</span><span class="o">.</span><span class="n">faf</span><span class="o">.</span><span class="n">faf95</span><span class="p">,</span>
                        <span class="n">ht</span><span class="o">.</span><span class="n">freq_meta</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gen_anc&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)),</span>
                    <span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">faf</span><span class="o">.</span><span class="n">faf95</span><span class="p">)),</span>
            <span class="p">),</span>
            <span class="n">faf99_max</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">or_missing</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">rand_bool</span><span class="p">(</span><span class="mf">0.3</span><span class="p">),</span> <span class="n">hl</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">faf</span><span class="o">.</span><span class="n">faf99</span><span class="p">)),</span>
            <span class="n">faf99_max_gen_anc</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">or_missing</span><span class="p">(</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">rand_bool</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="n">hl</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span>
                    <span class="n">hl</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span>
                        <span class="n">ht</span><span class="o">.</span><span class="n">faf</span><span class="o">.</span><span class="n">faf99</span><span class="p">,</span>
                        <span class="n">ht</span><span class="o">.</span><span class="n">freq_meta</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gen_anc&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)),</span>
                    <span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hl</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">faf</span><span class="o">.</span><span class="n">faf99</span><span class="p">)),</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">ht</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">grpmax</span><span class="o">=</span><span class="n">grpmax</span><span class="p">,</span> <span class="n">fafmax</span><span class="o">=</span><span class="n">fafmax</span><span class="p">)</span>
    <span class="c1"># Add monoallelic and only_het annotations.</span>
    <span class="n">ht</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">monoallelic</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">rand_bool</span><span class="p">(</span><span class="mf">0.50</span><span class="p">),</span> <span class="n">only_het</span><span class="o">=</span><span class="n">hl</span><span class="o">.</span><span class="n">rand_bool</span><span class="p">(</span><span class="mf">0.10</span><span class="p">))</span>
    <span class="n">ht</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">key_by</span><span class="p">(</span><span class="s2">&quot;locus&quot;</span><span class="p">,</span> <span class="s2">&quot;alleles&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ht</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../../api_reference/v5/data_ingestion/federated_validity_checks.html#gnomad_qc.v5.data_ingestion.federated_validity_checks.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform validity checks for federated data.&quot;&quot;&quot;</span>
    <span class="n">hl</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
        <span class="n">log</span><span class="o">=</span><span class="s2">&quot;/federated_validity_checks.log&quot;</span><span class="p">,</span>
        <span class="n">tmp_dir</span><span class="o">=</span><span class="s2">&quot;gs://gnomad-tmp-4day&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">hl</span><span class="o">.</span><span class="n">default_reference</span><span class="p">(</span><span class="s2">&quot;GRCh38&quot;</span><span class="p">)</span>
    <span class="n">test_n_partitions</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">test_n_partitions</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">config_path</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">exclude_xnonpar_y_in_logtest</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">use_logtest_ht</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;exclude_xnonpar_y_in_logtest can only be used with use_logtest_ht.&quot;</span>
        <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Read in config file and validate.</span>
        <span class="k">with</span> <span class="n">hl</span><span class="o">.</span><span class="n">hadoop_open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">validate_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

        <span class="c1"># Read in field necessity markdown file.</span>
        <span class="c1"># When submitting hail dataproc job, include &quot;--files field_requirements.md&quot;.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;field_requirements.md&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">md_text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="s2">&quot;Missing required file &#39;field_requirements.md&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;If running a Hail Dataproc job, be sure to include it with the --files argument:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;  hailctl dataproc submit &lt;cluster-name&gt; --files field_requirements.md  federated_validity_checks.py...&quot;</span>
            <span class="p">)</span>

        <span class="n">field_necessities</span><span class="p">,</span> <span class="n">field_types</span> <span class="o">=</span> <span class="n">parse_field_necessity_from_md</span><span class="p">(</span><span class="n">md_text</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_logtest_ht</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using logtest ht...&quot;</span><span class="p">)</span>
            <span class="n">ht</span> <span class="o">=</span> <span class="n">create_logtest_ht</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">exclude_xnonpar_y_in_logtest</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: Add resources to intake federated data once obtained.</span>
            <span class="n">ht</span> <span class="o">=</span> <span class="n">public_release</span><span class="p">(</span><span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;genomes&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ht</span><span class="p">()</span>

            <span class="c1"># Check that fields specified in the config are present in the Table.</span>
            <span class="n">validate_config_fields_in_ht</span><span class="p">(</span><span class="n">ht</span><span class="o">=</span><span class="n">ht</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

            <span class="c1"># Confirm Table is using build GRCh38.</span>
            <span class="n">build</span> <span class="o">=</span> <span class="n">get_reference_genome</span><span class="p">(</span><span class="n">ht</span><span class="o">.</span><span class="n">locus</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">build</span> <span class="o">!=</span> <span class="s2">&quot;GRCh38&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reference genome is </span><span class="si">{</span><span class="n">build</span><span class="si">}</span><span class="s2">, not GRCh38!&quot;</span><span class="p">)</span>

            <span class="c1"># Filter to test partitions if specified.</span>
            <span class="k">if</span> <span class="n">test_n_partitions</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Filtering to </span><span class="si">%d</span><span class="s2"> partitions and sex chromosomes...&quot;</span><span class="p">,</span>
                    <span class="n">test_n_partitions</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">test_ht</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">_filter_partitions</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">test_n_partitions</span><span class="p">))</span>

                <span class="n">x_ht</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">filter_intervals</span><span class="p">(</span>
                    <span class="n">ht</span><span class="p">,</span> <span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">parse_locus_interval</span><span class="p">(</span><span class="s2">&quot;chrX&quot;</span><span class="p">)]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">_filter_partitions</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">test_n_partitions</span><span class="p">))</span>

                <span class="n">y_ht</span> <span class="o">=</span> <span class="n">hl</span><span class="o">.</span><span class="n">filter_intervals</span><span class="p">(</span>
                    <span class="n">ht</span><span class="p">,</span> <span class="p">[</span><span class="n">hl</span><span class="o">.</span><span class="n">parse_locus_interval</span><span class="p">(</span><span class="s2">&quot;chrY&quot;</span><span class="p">)]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">_filter_partitions</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">test_n_partitions</span><span class="p">))</span>

                <span class="n">ht</span> <span class="o">=</span> <span class="n">test_ht</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">x_ht</span><span class="p">,</span> <span class="n">y_ht</span><span class="p">)</span>

        <span class="n">row_to_globals_check</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_fields&quot;</span><span class="p">][</span><span class="s2">&quot;freq&quot;</span><span class="p">]:</span> <span class="p">[</span>
                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_fields&quot;</span><span class="p">][</span><span class="s2">&quot;freq_meta&quot;</span><span class="p">],</span>
                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_fields&quot;</span><span class="p">][</span><span class="s2">&quot;freq_meta_sample_count&quot;</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_fields&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;freq_index_dict&quot;</span><span class="p">):</span>
            <span class="n">row_to_globals_check</span><span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_fields&quot;</span><span class="p">][</span><span class="s2">&quot;freq&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_fields&quot;</span><span class="p">][</span><span class="s2">&quot;freq_index_dict&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;faf_fields&quot;</span><span class="p">):</span>
            <span class="n">row_to_globals_check</span><span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;faf_fields&quot;</span><span class="p">][</span><span class="s2">&quot;faf&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;faf_fields&quot;</span><span class="p">][</span><span class="s2">&quot;faf_meta&quot;</span><span class="p">],</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;faf_fields&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;faf_index_dict&quot;</span><span class="p">):</span>
                <span class="n">row_to_globals_check</span><span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;faf_fields&quot;</span><span class="p">][</span><span class="s2">&quot;faf&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;faf_fields&quot;</span><span class="p">][</span><span class="s2">&quot;faf_index_dict&quot;</span><span class="p">]</span>
                <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check that row and global annotations lengths match...&quot;</span><span class="p">)</span>
        <span class="n">check_global_and_row_annot_lengths</span><span class="p">(</span>
            <span class="n">t</span><span class="o">=</span><span class="n">ht</span><span class="p">,</span>
            <span class="n">row_to_globals_check</span><span class="o">=</span><span class="n">row_to_globals_check</span><span class="p">,</span>
            <span class="n">check_all_rows</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">check_only_first_rows_to_globals</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">check_globals_for_retired_terms</span><span class="p">(</span><span class="n">ht</span><span class="p">)</span>

        <span class="c1"># Create row annotations for each element of the indexed arrays and their</span>
        <span class="c1"># structs.</span>
        <span class="n">array_struct_annotations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_fields&quot;</span><span class="p">][</span><span class="s2">&quot;freq&quot;</span><span class="p">]:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_fields&quot;</span><span class="p">][</span><span class="s2">&quot;freq_meta&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;faf_fields&quot;</span><span class="p">):</span>
            <span class="n">array_struct_annotations</span><span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;faf_fields&quot;</span><span class="p">][</span><span class="s2">&quot;faf&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span>
                <span class="s2">&quot;faf_fields&quot;</span>
            <span class="p">][</span><span class="s2">&quot;faf_meta&quot;</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validate required fields...&quot;</span><span class="p">)</span>
        <span class="n">field_issues</span><span class="p">,</span> <span class="n">type_issues</span><span class="p">,</span> <span class="n">fields_validated</span><span class="p">,</span> <span class="n">types_validated</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">validate_required_fields</span><span class="p">(</span>
                <span class="n">ht</span><span class="o">=</span><span class="n">ht</span><span class="p">,</span>
                <span class="n">field_types</span><span class="o">=</span><span class="n">field_types</span><span class="p">,</span>
                <span class="n">field_necessities</span><span class="o">=</span><span class="n">field_necessities</span><span class="p">,</span>
                <span class="n">validate_all_fields</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">validate_all_fields</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">log_field_validation_results</span><span class="p">(</span>
            <span class="n">field_issues</span><span class="p">,</span> <span class="n">fields_validated</span><span class="p">,</span> <span class="n">type_issues</span><span class="p">,</span> <span class="n">types_validated</span>
        <span class="p">)</span>

        <span class="c1"># TODO: Add in lof per person check.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unfurl array annotations...&quot;</span><span class="p">)</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="n">unfurl_array_annotations</span><span class="p">(</span>
            <span class="n">ht</span><span class="o">=</span><span class="n">ht</span><span class="p">,</span>
            <span class="n">array_meta_dicts</span><span class="o">=</span><span class="n">array_struct_annotations</span><span class="p">,</span>
            <span class="n">sorted_keys</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;sort_order&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">ht</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">ht</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="o">**</span><span class="n">annotations</span><span class="p">))</span>

        <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Add region_flag fields if present.</span>
        <span class="n">missing_region_flags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;region_flags&quot;</span> <span class="ow">in</span> <span class="n">ht</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">REGION_FLAG_FIELDS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ht</span><span class="p">[</span><span class="s2">&quot;region_flags&quot;</span><span class="p">]:</span>
                    <span class="n">info_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">ht</span><span class="p">[</span><span class="s2">&quot;region_flags&quot;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">missing_region_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">region_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">REGION_FLAG_FIELDS</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">missing_region_flags</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">missing_region_flags</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Missing region_flag fields: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">missing_region_flags</span><span class="p">)</span>

        <span class="c1"># Add allele_info fields if present.</span>
        <span class="n">missing_allele_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;allele_info&quot;</span> <span class="ow">in</span> <span class="n">ht</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ALLELE_TYPE_FIELDS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ht</span><span class="p">[</span><span class="s2">&quot;allele_info&quot;</span><span class="p">]:</span>
                    <span class="n">info_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">ht</span><span class="p">[</span><span class="s2">&quot;allele_info&quot;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">missing_allele_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_allele_info</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Missing allele type fields: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">missing_allele_info</span><span class="p">)</span>

        <span class="c1"># Add monoallelic and only_het fields to info dict.</span>
        <span class="k">if</span> <span class="s2">&quot;monoallelic&quot;</span> <span class="ow">in</span> <span class="n">ht</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;monoallelic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ht</span><span class="p">[</span><span class="s2">&quot;monoallelic&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;only_het&quot;</span> <span class="ow">in</span> <span class="n">ht</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;only_het&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ht</span><span class="p">[</span><span class="s2">&quot;only_het&quot;</span><span class="p">]</span>

        <span class="n">ht</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">ht</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="o">**</span><span class="n">info_dict</span><span class="p">))</span>

        <span class="c1"># If config specifies to check for monoallelic and only heterozygous sites,</span>
        <span class="c1"># create the site_gt_check_expr to pass to validate_federated_data.</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;check_mono_and_only_het&quot;</span><span class="p">):</span>
            <span class="n">site_gt_check_expr</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;monoallelic&quot;</span><span class="p">:</span> <span class="n">ht</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">monoallelic</span><span class="p">,</span>
                <span class="s2">&quot;only_het&quot;</span><span class="p">:</span> <span class="n">ht</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">only_het</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site_gt_check_expr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">validate_federated_data</span><span class="p">(</span>
            <span class="n">ht</span><span class="o">=</span><span class="n">ht</span><span class="p">,</span>
            <span class="n">missingness_threshold</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;missingness_threshold&quot;</span><span class="p">],</span>
            <span class="n">struct_annotations_for_missingness</span><span class="o">=</span><span class="n">config</span><span class="p">[</span>
                <span class="s2">&quot;struct_annotations_for_missingness&quot;</span>
            <span class="p">],</span>
            <span class="n">freq_meta_expr</span><span class="o">=</span><span class="n">ht</span><span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_fields&quot;</span><span class="p">][</span><span class="s2">&quot;freq_meta&quot;</span><span class="p">]],</span>
            <span class="n">freq_annotations_to_sum</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;freq_annotations_to_sum&quot;</span><span class="p">],</span>
            <span class="n">sort_order</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;sort_order&quot;</span><span class="p">],</span>
            <span class="n">nhomalt_metric</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nhomalt_metric&quot;</span><span class="p">],</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">subsets</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;subsets&quot;</span><span class="p">],</span>
            <span class="n">variant_filter_field</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;variant_filter_field&quot;</span><span class="p">],</span>
            <span class="n">problematic_regions</span><span class="o">=</span><span class="n">region_flags</span><span class="p">,</span>
            <span class="n">site_gt_check_expr</span><span class="o">=</span><span class="n">site_gt_check_expr</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">handler</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">log_output</span> <span class="o">=</span> <span class="n">log_stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

        <span class="c1"># TODO: Create resource functions when know organization of federated data.</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;.html&quot;</span>

        <span class="c1"># Write parsed log to html file.</span>
        <span class="k">with</span> <span class="n">hl</span><span class="o">.</span><span class="n">hadoop_open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_output</span><span class="p">)</span>

        <span class="n">parsed_logs</span> <span class="o">=</span> <span class="n">parse_log_file</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
        <span class="n">generate_html_report</span><span class="p">(</span><span class="n">parsed_logs</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copying hail log to logging bucket...&quot;</span><span class="p">)</span>
        <span class="n">hl</span><span class="o">.</span><span class="n">copy_log</span><span class="p">(</span><span class="n">get_logging_path</span><span class="p">(</span><span class="s2">&quot;federated_validity_checks&quot;</span><span class="p">))</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>

    <span class="c1"># Create a mutually exclusive group for --test-n-partitions and --use-test-ht.</span>
    <span class="n">test_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>

    <span class="n">test_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--test-n-partitions&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Use only N partitions of the input (as well as sex chromosomes) for testing purposes. Defaults&quot;</span>
            <span class="s2">&quot;to 2 if passed without a value. Cannot be used if --use-logtest-ht is set.&quot;</span>
        <span class="p">),</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>
        <span class="n">const</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">test_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--use-logtest-ht&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use a pre-defined Hail Table for testing of log output rather than loading data. Cannot be used if --test-n-partitions is set.&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--exclude-xnonpar-y-in-logtest&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Exclude chrX non-pseudoautosomal region and chrY variants when using the logtest data.&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--check-only-first-rows-to-globals&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Check only the first row when checking that the lengths of row annotations match the lengths of associated global annotations.&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--config-path&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Path to JSON config file for defining parameters. Paramters to define are as follows:&quot;</span>
            <span class="s2">&quot;missingness_threshold: Float defining upper cutoff for allowed amount of missingness. Missingness above this value will be flagged as &#39;FAILED&#39;.&quot;</span>
            <span class="s2">&quot;struct_annotations_for_missingness: List of struct annotations to check for missingness.&quot;</span>
            <span class="s2">&quot;freq_fields: Dictionary containing the names of frequency-related fields (&#39;freq&#39;: Name of annotation containing the array of frequency metric objects &quot;</span>
            <span class="s2">&quot;corresponding to each frequency metadata group; &#39;freq_meta&#39;: Name of annotation containing allele frequency metadata, an ordered list containing the frequency aggregation group for &quot;</span>
            <span class="s2">&quot;each element of the &#39;freq&#39; array row annotation, with at least the following groups: (&#39;group&#39;: adj/raw, &#39;gen_anc&#39;: inferred genetic ancestry group, &#39;sex&#39;: sex karyotype).; &#39;freq_meta_sample_count&#39;: Name of &quot;</span>
            <span class="s2">&quot;annotation containing sample count per sample grouping defined in the &#39;freq_meta&#39; global annotation.&quot;</span>
            <span class="s2">&quot;faf_fields: Dictionary containing the names of filtering allele frequency (FAF) related fields (&#39;faf&#39;: Name of annotation containing structs of FAF information; &#39;faf_meta&#39;: Name of annotation &quot;</span>
            <span class="s2">&quot;for FAF metadata, an ordered list containing the frequency aggregation group for each element of the &#39;faf&#39; arrays, with at least the following groups: (&#39;group&#39;: adj/raw, &#39;gen_anc&#39;: inferred genetic ancestry group, &#39;sex&#39;: sex karyotype). &quot;</span>
            <span class="s2">&quot;freq_annotations_to_sum: List of annotation fields within `freq_meta` to sum. Example: [&#39;AC&#39;, &#39;AN&#39;, &#39;homozygote_count&#39;].&quot;</span>
            <span class="s2">&quot;sort_order: Order in which groupings are unfurled into flattened annotations. Default is [&#39;gen_anc&#39;, &#39;sex&#39;, &#39;group&#39;].&quot;</span>
            <span class="s2">&quot;nhomalt_metric: Name of metric denoting homozygous alternate count.&quot;</span>
            <span class="s2">&quot;subsets: List of sample subsets to include for the subset validity check.&quot;</span>
            <span class="s2">&quot;variant_filter_field: String of variant filtration used in the filters annotation of the Hail Table (e.g. &#39;RF&#39;, &#39;VQSR&#39;, &#39;AS_VQSR&#39;).&quot;</span>
            <span class="s2">&quot;check_mono_and_only_het: Boolean indicating whether to check for monoallelic and 100 percent heterozygous sites in the Table (&#39;monoallelic&#39; and &#39;only_het&#39; annotations must be present).&quot;</span>
        <span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--validate-all-fields&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Validate all fields, regardless of necessity status.&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Log successes in addition to failures during validation&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--output-base&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Base path for output files. Will be used to create a log file and an html file.&quot;</span>
        <span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;gs://gnomad-tmp/federated_validity_checks/federated_validity_checks&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>